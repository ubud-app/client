stages:
  - build
  - check
  - publish

publish_github:
  stage: build
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - git push "https://${GITHUB_AUTH}@github.com/sebbo2002/dwimm-client.git" --all
    - git push "https://${GITHUB_AUTH}@github.com/sebbo2002/dwimm-client.git" --tags

check_lint:
  stage: check
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - yarn install
    - yarn run check


visualize:
  stage: check
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - yarn install
    - npm run visualize
    - rm -rf /var/docker/static/dwimm/client-web/plato/*
    - mv ./code-visualization/* /var/docker/static/dwimm/client-web/plato/


publish_npm_next:
  stage: publish
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - node -v
    - yarn -v
    - yarn install
    - npm config set //registry.npmjs.org/:_authToken $NPM_TOKEN
    - npm run bump:develop
    - npm run build
    - echo $(cat ./package.json | jq '.version' -rce)
    - sentry-cli releases new "$(cat ./package.json| jq -rM '.version')"
    - sentry-cli releases set-commits "$(cat ./package.json| jq -rM '.version')" --auto
    - sentry-cli releases files "$(cat ./package.json| jq -rM '.version')" upload-sourcemaps ./dist/main.js.map --rewrite
    - npm publish --tag "next"
    - sentry-cli releases finalize "$(cat ./package.json| jq -rM '.version')"
  only:
    - develop

stages:
  - prepare
  - check
  - publish
  - notify

prepare:
  stage: prepare
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - npm ci
    - tar -czf "node_modules.tar.gz" ./node_modules
  artifacts:
    paths:
      - node_modules.tar.gz
    expire_in: 1 day

checks:
  stage: check
  tags:
    - matt.sebbo.net
    - ssh
  except:
    - tags
  script:
    - tar -xzf "node_modules.tar.gz" -C .
    - rm -f ./node_modules.tar.gz
    - npm run check

publish_github:
  stage: publish
  tags:
    - matt.sebbo.net
    - ssh
  retry: 2
  script:
    - git checkout $CI_COMMIT_REF_NAME
    - git pull
    - git push "https://${GITHUB_AUTH}@github.com/sebbo2002/dwimm-client.git" --all
    - git push "https://${GITHUB_AUTH}@github.com/sebbo2002/dwimm-client.git" --tags
  only:
    - master
    - develop

publish_npm_next:
  stage: publish
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - tar -xzf "node_modules.tar.gz" -C .
    - rm -f ./node_modules.tar.gz
    - npm config set //registry.npmjs.org/:_authToken $NPM_TOKEN
    - export OLDVERSION=$(npm view @dwimm/client-web@next version)
    - jq -M ".version=\"$OLDVERSION\"" package.json|sponge package.json
    - npm --no-git-tag-version version prerelease
    - export NEWVERSION=$(cat ./package.json| jq -rM '.version')
    - npx sentry-cli releases new "$NEWVERSION"
    - npx sentry-cli releases set-commits --auto $NEWVERSION
    - npm run build
    - npm publish --tag "next"
    - npx sentry-cli releases finalize "$NEWVERSION"
  only:
    - develop

notify:
  stage: notify
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - curl -X "POST" "https://api.repository.dwimm.org/webhooks/update-components/${NOTIFY_WEBHOOK_SECRET}"
  only:
    - develop
    - master
